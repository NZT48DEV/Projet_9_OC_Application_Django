{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<div class="container mt-4">

    <!-- ✅ Carte détaillée de la critique -->
    <div class="card card-elevated p-4 mb-5">
        <!-- Header -->
        <div class="d-flex justify-content-between mb-3">
            <p class="mb-0 text-muted fst-italic">
                {% if request.user == review.user %}
                    Vous avez publié cette critique
                {% else %}
                    {{ review.user.username }} a publié une critique
                {% endif %}
            </p>
            <small class="text-muted">
                <i class="bi bi-clock"></i> {{ review.time_created|date:"d/m/Y H:i" }}
            </small>
        </div>

        <!-- Contenu critique -->
        <div class="text-center mb-3">
            <h3 class="fw-bold mb-3">{{ review.headline }}</h3>

            <!-- Note -->
            <p class="fs-5 text-warning">
                {% for i in "12345" %}
                    {% if forloop.counter <= review.rating %}
                        <span style="color: gold;">★</span>
                    {% else %}
                        <span style="color: lightgray;">☆</span>
                    {% endif %}
                {% endfor %}
            </p>

            <!-- Corps -->
            <p class="lead text-muted">{{ review.body|linebreaksbr }}</p>
        </div>

        <!-- Boutons si c'est l'utilisateur -->
        {% if request.user == review.user %}
            <div class="d-flex justify-content-end mt-3 gap-2">
                <a href="{% url 'update_review' review.id %}?next={{ request.path }}" 
                   class="btn btn-outline-warning btn-sm">
                   <i class="bi bi-pencil-square"></i> Modifier
                </a>
                <a href="{% url 'delete_review' review.id %}?next={{ request.path }}" 
                   class="btn btn-outline-danger btn-sm">
                   <i class="bi bi-trash"></i> Supprimer
                </a>
            </div>
        {% endif %}
    </div>

    <!-- ✅ Ticket associé -->
    {% if review.ticket %}
        <div class="card card-elevated border-0 shadow-sm p-4">
            <h5 class="fw-bold mb-3">Ticket associé</h5>
            <div class="card bg-light border p-3">
                <div class="text-center mb-3">
                    <h4 class="fw-bold">{{ review.ticket.title }}</h4>
                    <p class="text-muted">{{ review.ticket.description|linebreaksbr }}</p>
                    {% if review.ticket.image %}
                        <div class="my-3">
                            <img src="{{ review.ticket.image.image.url }}" 
                                 alt="image du ticket" 
                                 class="img-fluid rounded shadow-sm"
                                 style="max-height: 300px; object-fit: contain;">
                        </div>
                    {% endif %}
                </div>

                <!-- Bouton voir ticket -->
                <div class="text-end">
                    <a href="{% url 'view_ticket' review.ticket.id %}" 
                       class="btn btn-outline-primary btn-sm">
                       <i class="bi bi-eye"></i> Voir le ticket
                    </a>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- ✅ Bouton retour -->
    <div class="text-center">
        <a href="{{ next|default:'/' }}" class="btn btn-secondary btn-lg mt-4 mb-4">
            <i class="bi bi-x-circle"></i> Retour
        </a>
    </div>
</div>
{% endblock content %}
