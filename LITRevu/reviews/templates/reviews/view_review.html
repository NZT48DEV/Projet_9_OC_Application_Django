{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container mb-5" role="main">

    <!-- ✅ Bloc principal de la critique -->
    <div class="card card-elevated p-4 mb-5">
        
        <!-- En-tête : auteur + date -->
        <div class="d-flex justify-content-between mb-3">
            <p class="mb-0 text-muted fst-italic">
                {% if request.user == review.user %}
                    Vous avez publié cette critique
                {% else %}
                    {{ review.user.username }} a publié une critique
                {% endif %}
            </p>
            <small class="text-muted">
                <i class="bi bi-clock" aria-hidden="true"></i> {{ review.time_created|format_date }}
            </small>
        </div>

        <!-- Contenu de la critique -->
        <div class="text-center mb-3">
            <h2 class="fw-bold mb-3">{{ review.headline }}</h2>

            <!-- Note (étoiles) -->
            <p class="fs-5 text-warning" aria-label="Note attribuée : {{ review.rating }} sur 5">
                {% for i in "12345" %}
                    {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                {% endfor %}
            </p>

            <!-- Corps du texte -->
            <p class="lead text-muted">{{ review.body|linebreaksbr }}</p>
        </div>

        <!-- Actions si c'est l'auteur -->
        {% if review.user == request.user %}
            <div class="text-end mt-2">
                <a href="{% url 'update_review' review.id %}" 
                   class="btn btn-outline-warning btn-sm me-2"
                   aria-label="Modifier la critique {{ review.headline }}">
                    <i class="bi bi-pencil-square" aria-hidden="true"></i> Modifier
                </a>
                <a href="{% url 'delete_review' review.id %}" 
                   class="btn btn-outline-danger btn-sm"
                   aria-label="Supprimer la critique {{ review.headline }}">
                    <i class="bi bi-trash" aria-hidden="true"></i> Supprimer
                </a>
            </div>
        {% endif %}
    </div>

    <!-- ✅ Bloc ticket associé -->
    {% if review.ticket %}
        <div class="card card-elevated border-0 shadow-sm p-4">
            <h3 class="fw-bold mb-3">Ticket associé</h3>

            <div class="card bg-light border p-3">
                <h4 class="fw-bold">{{ review.ticket.title }}</h4>
                <p class="text-muted">{{ review.ticket.description|linebreaksbr }}</p>

                <!-- Image du ticket (avec taille limitée) -->
                {% if review.ticket.image %}
                    <div class="text-center my-3">
                        <img src="{{ review.ticket.image.image.url }}" 
                             alt="Image associée au ticket {{ review.ticket.title }}" 
                             class="img-fluid rounded shadow-sm"
                             style="max-height: 400px; object-fit: contain;">
                    </div>
                {% endif %}

                <!-- Bouton modifier/supprimer le ticket associée -->
                {% if review.user == request.user %}
                    <div class="text-end mt-2">
                        <a href="{% url 'update_ticket' review.ticket.id %}" 
                        class="btn btn-outline-warning btn-sm me-2"
                        aria-label="Modifier le ticket associé">
                            <i class="bi bi-pencil-square" aria-hidden="true"></i> Modifier
                        </a>
                        <a href="{% url 'delete_ticket' review.ticket.id %}" 
                        class="btn btn-outline-danger btn-sm"
                        aria-label="Supprimer le ticket associé">
                            <i class="bi bi-trash" aria-hidden="true"></i> Supprimer
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
