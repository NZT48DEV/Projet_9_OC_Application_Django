{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

<div class="container mt-4">

    <!-- ‚úÖ Bloc encadr√© avec ombre pour les actions -->
    <div class="card p-4 mb-5 text-center shadow-sm">
        <!-- Boutons haut de page -->
        <div class="d-flex justify-content-center gap-4 mb-4">
            <a href="{% url 'create_ticket' %}" class="btn btn-outline-primary btn-lg rounded-pill">
                üìö Demander une critique
            </a>
            <a href="{% url 'create_review_with_ticket' %}" class="btn btn-outline-success btn-lg rounded-pill">
                ‚úçÔ∏è Cr√©er une critique
            </a>
        </div>

        <!-- Onglets filtre -->
        <ul class="nav nav-pills justify-content-center">
            <li class="nav-item">
                <a href="?filter=all" class="nav-link {% if filter_mode == 'all' %}active{% endif %}">
                    Tous les posts
                </a>
            </li>
            <li class="nav-item">
                <a href="?filter=following" class="nav-link {% if filter_mode == 'following' %}active{% endif %}">
                    Mes abonnements
                </a>
            </li>
        </ul>
    </div>

    <!-- Flux -->
    {% if tickets %}
        {% for ticket in tickets %}
            <div class="card mb-4 p-3 shadow-sm">

                <!-- ‚úÖ Partial ticket -->
                {% include "tickets/partials/_ticket_card.html" with ticket=ticket %}

                <!-- Critiques associ√©es -->
                {% if ticket.review_set.all %}
                    {% for review in ticket.review_set.all %}
                        <div class="card bg-light p-3 mt-3 border-0 shadow-sm">
                            {% include "reviews/partials/_review_card.html" with review=review hide_ticket=True %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="card bg-light p-3 mt-3 border-secondary shadow-sm">
                        <p class="text-muted mb-0">Aucune critique pour le moment.</p>
                    </div>
                {% endif %}

                <!-- Bouton cr√©er une critique si aucune critique -->
                {% if not ticket.review_set.exists %}
                    <div class="text-end mt-2">
                        <a href="{% url 'create_review_response' ticket.id %}?next={{ request.path }}" class="btn btn-success">
                            ‚ûï Ajouter une critique
                        </a>
                    </div>
                {% endif %}

            </div>
        {% endfor %}
    {% else %}
        <div class="card text-center shadow-sm border-0 bg-light p-5 mt-4">
            <div class="mb-3">
                <i class="bi bi-emoji-frown fs-1 text-secondary"></i>
            </div>
            <h5 class="fw-bold">
                {% if filter_mode == "following" %}
                    Vous n'avez aucun post de vos abonnements pour le moment.
                {% else %}
                    Aucun post disponible.
                {% endif %}
            </h5>
            <p class="text-muted">Pourquoi ne pas cr√©er votre propre post ?</p>
            <div class="mt-3">
                <a href="{% url 'create_ticket' %}" class="btn btn-outline-primary me-2">üìö Demander une critique</a>
                <a href="{% url 'create_review_with_ticket' %}" class="btn btn-outline-success">‚úçÔ∏è Cr√©er une critique</a>
            </div>
        </div>
    {% endif %}
</div>

{% endblock %}
